---
import { getCollection } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import GlossaryCard from '../components/GlossaryCard.astro';

const videos = await getCollection('videos');
const articles = await getCollection('articles');
const glossary = await getCollection('topic');
const atomicNotes = await getCollection('atomic-notes');

// Extract summary section from markdown body
function extractSummary(body: string): string {
  // Find the "## Ê¶ÇË¶Å" section
  const summaryMatch = body.match(/##\s*Ê¶ÇË¶Å\s*\n([\s\S]*?)(?=\n##[^#]|$)/);
  if (!summaryMatch) return '';
  return summaryMatch[1].trim();
}

// Remove summary section from body
function removeSummaryFromBody(body: string): string {
  // Remove everything from the first heading (# title) to the end of "## Ê¶ÇË¶Å" section
  const withoutSummary = body.replace(/^#\s+[^\n]+\n+##\s*Ê¶ÇË¶Å\s*\n[\s\S]*?(?=\n##[^#])/m, '');
  return withoutSummary.trim();
}

// Render all notes to get HTML content
const renderedNotes = await Promise.all(
  atomicNotes.map(async (note) => {
    const { Content } = await note.render();
    const summary = extractSummary(note.body);
    const bodyWithoutSummary = removeSummaryFromBody(note.body);

    // Render body without summary
    const { Content: BodyContent } = await note.render();

    return { ...note, Content, summary, bodyWithoutSummary, BodyContent };
  })
);

// Extract seminar sections from markdown body
function extractSeminarSections(body: string): Array<{ title: string; time: string; link: string; description: string }> {
  const sections: Array<{ title: string; time: string; link: string; description: string }> = [];

  // Find the "„Çª„Éü„Éä„ÉºÊßãÊàê" section
  const seminarSectionMatch = body.match(/##\s*„Çª„Éü„Éä„ÉºÊßãÊàê\s*\n([\s\S]*?)(?=\n##[^#]|$)/);
  if (!seminarSectionMatch) return sections;

  const seminarContent = seminarSectionMatch[1];

  // Extract each subsection (###)
  // Updated regex to handle both formats:
  // 1. Description on the same line or next line (Seminar format)
  // 2. Description after a blank line (Obsidian„ÅÆÂÖ®ÊäÄË°ì format)
  const subsectionRegex = /###\s*\[([^\]]+)\]\(([^)]+)\)\s*\n\*\*ÊôÇÈñì\*\*:\s*([^\n]+)\s*\n+([^\n#]+)?/g;
  let match;

  while ((match = subsectionRegex.exec(seminarContent)) !== null) {
    sections.push({
      title: match[1],
      link: match[2],
      time: match[3].replace(/ÔΩû$/, '').trim(),
      description: (match[4] || '').trim()
    });
  }

  return sections;
}

// Process videos (Seminars and Obsidian„ÅÆÂÖ®ÊäÄË°ì)
const processedVideos = videos.map((video) => {
  const hasStructuredSections = video.data.series_name === '„Çª„Éü„Éä„Éº' || video.data.series_name === 'Obsidian„ÅÆÂÖ®ÊäÄË°ì';
  let sections = [];

  if (hasStructuredSections && video.body) {
    sections = extractSeminarSections(video.body);
    if (video.data.series_name === 'Obsidian„ÅÆÂÖ®ÊäÄË°ì') {
      console.log('Obsidian„ÅÆÂÖ®ÊäÄË°ì:', video.data.title, 'sections:', sections.length);
    }
  }

  return { ...video, sections, hasStructuredSections };
}).sort((a, b) => {
  const dateA = new Date(a.data.date_published);
  const dateB = new Date(b.data.date_published);
  return dateB.getTime() - dateA.getTime();
});

// Process articles
const sortedArticles = articles.sort((a, b) => {
  const dateA = new Date(a.data.date_published);
  const dateB = new Date(b.data.date_published);
  return dateB.getTime() - dateA.getTime();
});

// Extract folder structure for series hierarchy (from articles)
function getFolderPath(id: string): { parent: string; child: string | null } {
  const parts = id.split('/');
  parts.pop();

  if (parts.length === 0) {
    return { parent: '„Åù„ÅÆ‰ªñ', child: null };
  } else if (parts.length === 1) {
    return { parent: parts[0], child: null };
  } else {
    return { parent: parts[0], child: parts[1] };
  }
}

const seriesHierarchy: Record<string, { count: number; children: Record<string, number> }> = {};
sortedArticles.forEach(article => {
  const { parent, child } = getFolderPath(article.id);
  if (!seriesHierarchy[parent]) {
    seriesHierarchy[parent] = { count: 0, children: {} };
  }
  seriesHierarchy[parent].count++;
  if (child) {
    if (!seriesHierarchy[parent].children[child]) {
      seriesHierarchy[parent].children[child] = 0;
    }
    seriesHierarchy[parent].children[child]++;
  }
});
const parentSeries = Object.keys(seriesHierarchy).sort();

// Get glossary categories and render content
const glossaryByCategory: Record<string, typeof glossary> = {};
glossary.forEach(term => {
  const category = term.data.category;
  if (!glossaryByCategory[category]) {
    glossaryByCategory[category] = [];
  }
  glossaryByCategory[category].push(term);
});
const glossaryCategories = Object.keys(glossaryByCategory).sort();

// Render glossary content for WikiLinks
const renderedGlossary = await Promise.all(
  glossary.map(async (term) => {
    const { Content } = await term.render();
    return { ...term, Content };
  })
);

// Sort atomic notes by prefix (if available) or title
const sortedAtomicNotes = renderedNotes.sort((a, b) => {
  if (a.data.prefix && b.data.prefix) {
    return a.data.prefix.localeCompare(b.data.prefix);
  }
  if (a.data.prefix) return -1;
  if (b.data.prefix) return 1;
  const titleA = a.data.title || a.slug || '';
  const titleB = b.data.title || b.slug || '';
  return titleA.localeCompare(titleB);
});
---

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300;500;700&family=M+PLUS+Rounded+1c:wght@300;500&display=swap" rel="stylesheet">
    <ViewTransitions />
    <style>
      :root {
        --bg-gradient: linear-gradient(135deg, #f2f2f7 0%, #ffffff 100%);
        --glass-bg: rgba(255, 255, 255, 0.4);
        --glass-border: rgba(255, 255, 255, 0.6);
        --text-main: #1c1c1e;
        --text-secondary: #3a3a3c;
        --text-tertiary: #8e8e93;
        --accent: #007aff;
        --spacing-xs: 4px;
        --spacing-sm: 8px;
        --spacing-md: 16px;
        --spacing-lg: 24px;
        --spacing-xl: 32px;
        --radius-lg: 20px;
        --radius-xl: 24px;
        --shadow-glass: 0 8px 32px 0 rgba(0, 0, 0, 0.05);
        --blur: 12px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Quicksand', 'M PLUS Rounded 1c', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
        margin: 0;
        padding: 0;
        background: #e0e5ec;
        color: var(--text-main);
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* „Åµ„Çè„Å£„Å®Ë°®Á§∫„Åï„Çå„Çã„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ - È´òÈÄüÂåñ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ËÉåÊôØ„ÅÆÂãï„Åè„Éú„Éº„É´ (Ë£ÖÈ£æ) */
      .blob {
        position: fixed;
        border-radius: 50%;
        filter: blur(60px);
        z-index: -1;
        opacity: 0.8;
        animation: float 10s infinite alternate;
      }
      .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #ffafbd; }
      .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #2193b0; animation-delay: -5s; }

      @keyframes float {
        0% { transform: translate(0, 0); }
        100% { transform: translate(30px, 50px); }
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 4rem 2rem;
      }

      .header {
        margin-bottom: var(--spacing-xl);
        opacity: 0;
        animation: fadeInUp 0.4s ease-out forwards;
      }

      .site-title {
        font-size: 2.5rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        margin-bottom: var(--spacing-lg);
        text-align: center;
        color: #333;
      }


      /* Main filter buttons - horizontal */
      .main-filter-buttons {
        display: flex;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
        flex-wrap: wrap;
      }

      .main-filter-button {
        padding: 0.8rem 1.5rem;
        border: 1px solid #fff;
        border-radius: 50px;
        font-size: 0.95rem;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        color: #555;
        cursor: pointer;
        transition: 0.3s;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .main-filter-button:hover {
        background: #fff;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }

      .main-filter-button.active {
        background: #fff;
        color: #333;
        border-color: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }

      /* Filter list section - separate island */
      .filter-list-section {
        margin-bottom: var(--spacing-md);
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: var(--spacing-md);
        box-shadow: var(--shadow-glass);
        display: none;
        opacity: 0;
        transition: 0.3s;
      }

      .filter-list-section.visible {
        display: block;
        opacity: 1;
      }

      /* Series list - horizontal tabs */
      .series-list {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      .series-item {
        display: contents;
      }

      .filter-buttons {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      .topic-list {
        display: flex;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
      }

      .filter-button {
        padding: 6px 14px;
        border: 1px solid #fff;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.3);
        color: #555;
        cursor: pointer;
        transition: 0.3s;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
      }

      .filter-button:hover {
        background: #fff;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }

      .filter-button.active {
        background: #fff;
        color: #333;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }

      /* Arrow icon */
      .arrow {
        font-size: 0.65rem;
        transition: transform 0.1s ease;
        display: inline-block;
      }

      .parent-button.expanded .arrow {
        transform: rotate(90deg);
      }

      .filter-count {
        font-size: 0.7rem;
        opacity: 0.7;
        font-weight: 600;
      }

      .filter-button.active .filter-count {
        opacity: 0.9;
      }

      /* Child series - horizontal second row */
      .child-series {
        display: none;
        gap: var(--spacing-xs);
        flex-wrap: wrap;
        width: 100%;
        padding-left: var(--spacing-lg);
        margin-top: var(--spacing-xs);
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.15s ease, opacity 0.15s ease;
      }

      .child-series.visible {
        display: flex;
        max-height: 500px;
        opacity: 1;
      }

      .child-button {
        background: rgba(255, 255, 255, 0.25);
        font-size: 0.75rem;
        padding: 4px 10px;
      }

      .child-button:hover {
        background: rgba(255, 255, 255, 0.5);
      }

      /* Sort */
      .sort-section {
        margin-bottom: var(--spacing-md);
      }

      .sort-select {
        padding: 6px 14px;
        border: 1px solid var(--glass-border);
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #555;
        cursor: pointer;
        transition: 0.3s;
      }

      .sort-select:hover {
        background: #fff;
      }

      .sort-select:focus {
        outline: none;
        border-color: var(--color-accent);
      }

      /* Result header - compact */
      .result-header {
        margin-bottom: var(--spacing-md);
        padding-top: var(--spacing-sm);
        display: flex;
        align-items: baseline;
        gap: var(--spacing-sm);
      }

      .result-header h2 {
        font-size: 1.1rem;
        font-weight: 700;
        letter-spacing: -0.02em;
        color: var(--color-text);
      }

      .result-count {
        color: var(--color-text-secondary);
        font-size: 0.8rem;
        font-weight: 500;
      }

      .clear-filter-btn {
        padding: 6px 14px;
        border: 1px solid #fff;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        background: rgba(255, 59, 48, 0.1);
        color: #ff3b30;
        cursor: pointer;
        transition: 0.3s;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        margin-left: auto;
      }

      .clear-filter-btn:hover {
        background: rgba(255, 59, 48, 0.2);
        transform: translateY(-1px);
      }

      /* Article list - compact */
      .article-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      /* Sort and Controls */
      .controls-section {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
        margin-top: var(--spacing-md);
        padding: 4px;
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }

      /* Floating Controls (Permanent Sticky Bar) */
      .floating-controls {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        padding: 8px 16px;
        transform: translateY(-100%);
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto;
      }

      .floating-controls.visible {
        transform: translateY(0);
      }

      .floating-container {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-md);
      }

      .floating-controls .main-filter-buttons {
        margin-bottom: 0;
        gap: 4px;
        flex-wrap: wrap;
      }

      .floating-controls .main-filter-button {
        padding: 6px 12px;
        font-size: 1.1rem;
        background: transparent;
        border: none;
        backdrop-filter: none;
        box-shadow: none;
        color: var(--color-text);
        white-space: nowrap;
      }

      .floating-controls .main-filter-button.active {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        color: var(--color-text);
      }

      .floating-controls .controls-section {
        margin-top: 0;
        background: transparent;
        backdrop-filter: none;
        border: none;
        padding: 0;
        gap: 8px;
      }

      .floating-controls .segmented-control {
        padding: 1px;
        background: rgba(0, 0, 0, 0.03);
      }

      .floating-controls .segmented-control-option {
        padding: 4px 8px;
        font-size: 1rem;
        color: var(--color-text);
      }

      .floating-controls .bulk-toggle-btn {
        padding: 6px 10px;
        font-size: 1rem;
        background: transparent;
        border: none;
        box-shadow: none;
        color: var(--color-text);
      }

      @media (max-width: 768px) {
        .floating-controls .controls-section {
          display: none;
        }

        .floating-controls .main-filter-buttons {
          width: 100%;
          overflow-x: auto;
          flex-wrap: nowrap;
        }

        .floating-controls .main-filter-button {
          padding: 8px 12px;
          font-size: 1.2rem;
          white-space: nowrap;
          flex-shrink: 0;
        }
      }

      .segmented-control {
        display: flex;
        background: rgba(0, 0, 0, 0.05);
        padding: 2px;
        border-radius: 12px;
        position: relative;
        flex: 1;
      }

      .segmented-control-option {
        flex: 1;
        padding: 8px 12px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-text-secondary);
        border: none;
        background: transparent;
        cursor: pointer;
        z-index: 1;
        transition: color 0.3s ease;
        white-space: nowrap;
      }

      .segmented-control-option.active {
        color: var(--color-text);
      }

      .segmented-control-slider {
        position: absolute;
        top: 2px;
        left: 2px;
        width: calc(50% - 2px);
        height: calc(100% - 4px);
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      }

      .segmented-control[data-value="oldest"] .segmented-control-slider {
        transform: translateX(100%);
      }

      .bulk-toggle-btn {
        padding: 8px 16px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-accent);
        background: white;
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        white-space: nowrap;
      }

      .bulk-toggle-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .bulk-toggle-btn:active {
        transform: translateY(0);
      }

      .article-card {
        background: var(--glass-bg);
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        transition: 0.3s;
        box-shadow: var(--shadow-glass);
        opacity: 0;
        animation: fadeInUp 0.4s ease-out forwards;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .article-card:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }

      .article-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--spacing-md);
      }

      .article-content {
        flex: 1;
      }

      .article-toggle-icon {
        font-size: 0.8rem;
        color: var(--text-tertiary);
        transition: transform 0.3s ease;
        padding-top: 0.5rem;
      }

      .article-card.expanded .article-toggle-icon {
        transform: rotate(180deg);
      }

      .article-description {
        font-size: 0.85rem;
        color: var(--text-secondary);
        line-height: 1.6;
        margin-top: var(--spacing-sm);
        max-width: 600px; /* ÁîªÈù¢ÂπÖ„ÅåÂ∫É„Åè„Å™„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´Âà∂Èôê */
      }

      .article-card.expanded .article-description {
        -webkit-line-clamp: unset;
      }

      .article-footer {
        margin-top: var(--spacing-md);
        display: none;
        justify-content: flex-end;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .article-card.expanded .article-footer {
        display: flex;
        opacity: 1;
      }

      .read-more-btn {
        padding: 0.5rem 1rem;
        background: #fff;
        border: 1px solid var(--glass-border);
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 700;
        color: #555;
        text-decoration: none;
        transition: 0.3s;
      }

      .read-more-btn:hover {
        background: var(--accent);
        color: #fff;
        border-color: var(--accent);
      }

      .article-meta {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-sm);
        flex-wrap: wrap;
      }

      .series-badge {
        background: rgba(0, 122, 255, 0.1);
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--color-accent);
      }

      .article-date {
        color: var(--color-text-tertiary);
        font-size: 0.7rem;
        font-weight: 500;
      }

      .article-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--color-text);
        margin-bottom: var(--spacing-xs);
        line-height: 1.4;
        letter-spacing: -0.01em;
      }

      .article-topic {
        display: inline-block;
        background: linear-gradient(135deg, rgba(88, 86, 214, 0.12) 0%, rgba(0, 122, 255, 0.12) 100%);
        color: #5856d6;
        padding: 2px 8px;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 600;
      }

      .article-link {
        color: inherit;
        text-decoration: none;
        display: block;
      }

      .empty-state {
        text-align: center;
        padding: var(--spacing-xl) * 2;
        color: var(--color-text-secondary);
        background: var(--color-glass);
        backdrop-filter: blur(var(--blur));
        -webkit-backdrop-filter: blur(var(--blur));
        border: 1px solid var(--color-glass-border);
        border-radius: var(--radius-xl);
        font-size: 1rem;
        font-weight: 500;
      }

      /* Glossary list */
      .glossary-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .glossary-card-wrapper {
        opacity: 0;
        animation: fadeInUp 0.4s ease-out forwards;
      }

      /* Glossary details - hidden by default, shown when expanded */
      .glossary-details {
        margin-top: var(--spacing-md);
        padding: var(--spacing-md);
        background: rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-lg);
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .glossary-card-wrapper.expanded .glossary-details {
        display: block;
        opacity: 1;
      }

      /* Glossary content styling for WikiLinks */
      .glossary-card-wrapper :global(.glossary-links p) {
        margin: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
      }

      .glossary-card-wrapper :global(.glossary-links h1),
      .glossary-card-wrapper :global(.glossary-links h2),
      .glossary-card-wrapper :global(.glossary-links h3),
      .glossary-card-wrapper :global(.glossary-links ul),
      .glossary-card-wrapper :global(.glossary-links ol),
      .glossary-card-wrapper :global(.glossary-links li) {
        display: none;
      }

      /* Note details - hidden by default, shown when expanded */
      .note-details {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: none;
        opacity: 0;
        transition: opacity 0.3s ease;
      }

      .article-card.expanded .note-details {
        display: block;
        opacity: 1;
      }

      .note-body-preview {
        font-size: 0.8rem;
        line-height: 1.5;
        color: var(--text-secondary);
      }

      .note-body-preview p {
        margin-bottom: var(--spacing-xs);
      }

      .note-body-preview p:empty {
        display: none;
      }

      .note-body-preview h1,
      .note-body-preview h2,
      .note-body-preview h3,
      .note-body-preview h4,
      .note-body-preview h5,
      .note-body-preview h6 {
        font-size: 0.85rem;
        font-weight: 600;
        margin-top: var(--spacing-md);
        margin-bottom: var(--spacing-xs);
        color: var(--text-main);
      }

      .note-body-preview h1 {
        font-size: 0.9rem;
      }

      .note-body-preview ul,
      .note-body-preview ol {
        margin-left: var(--spacing-md);
        margin-bottom: var(--spacing-xs);
      }

      .note-body-preview li {
        margin-bottom: 2px;
      }

      .note-body-preview code {
        background: rgba(0, 0, 0, 0.05);
        padding: 1px 4px;
        border-radius: 3px;
        font-size: 0.75rem;
      }

      .note-body-preview pre {
        background: rgba(0, 0, 0, 0.05);
        padding: var(--spacing-sm);
        border-radius: var(--spacing-sm);
        overflow-x: auto;
        margin-bottom: var(--spacing-sm);
        font-size: 0.75rem;
      }

      .note-body-preview blockquote {
        border-left: 3px solid rgba(0, 0, 0, 0.1);
        padding-left: var(--spacing-sm);
        margin: var(--spacing-sm) 0;
        color: var(--text-tertiary);
        font-style: italic;
      }

      .note-body-preview a {
        color: var(--accent);
        text-decoration: none;
      }

      .note-body-preview a:hover {
        text-decoration: underline;
      }

      .wiki-link {
        color: var(--accent);
        text-decoration: none;
        background: rgba(0, 122, 255, 0.08);
        padding: 1px 4px;
        border-radius: 3px;
        transition: all 0.15s ease;
      }

      .wiki-link:hover {
        background: rgba(0, 122, 255, 0.15);
        text-decoration: none;
      }

      .glossary-section-title {
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: var(--spacing-xs);
      }

      .glossary-recommended {
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-sm);
        background: rgba(0, 122, 255, 0.05);
        border-radius: var(--radius-lg);
      }

      .glossary-recommended-list {
        list-style: none;
        margin: var(--spacing-xs) 0 0 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .glossary-recommended-list li {
        padding-left: var(--spacing-md);
        position: relative;
      }

      .glossary-recommended-list li::before {
        content: "‚Ä¢";
        position: absolute;
        left: 0;
        color: var(--color-accent);
        font-weight: bold;
      }

      .glossary-recommended-list a {
        color: var(--color-accent);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: color 0.15s ease;
      }

      .glossary-recommended-list a:hover {
        color: #5856d6;
        text-decoration: underline;
      }

      .glossary-related {
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        padding-top: var(--spacing-md);
        margin-top: var(--spacing-md);
      }

      /* Mobile Adjustments - Universal Design */
      @media (max-width: 768px) {
        .container {
          padding: 1.5rem 1rem;
        }

        .site-title {
          font-size: 1.75rem;
          margin-bottom: var(--spacing-md);
        }

        .main-filter-buttons {
          gap: 6px;
          overflow-x: auto;
          padding-bottom: 8px;
          -webkit-overflow-scrolling: touch;
          flex-wrap: nowrap;
        }

        .main-filter-button {
          padding: 0.75rem 1.25rem;
          font-size: 1rem;
          min-width: 80px;
          flex-shrink: 0;
          white-space: nowrap;
        }

        .filter-button {
          padding: 10px 18px;
          font-size: 0.95rem;
          min-height: 44px; /* Tap target size */
        }

        .controls-section {
          flex-direction: column;
          align-items: stretch;
          background: transparent;
          border: none;
          backdrop-filter: none;
          -webkit-backdrop-filter: none;
          padding: 0;
          gap: var(--spacing-sm);
        }

        .segmented-control {
          background: rgba(255, 255, 255, 0.3);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .segmented-control-option {
          font-size: 1rem;
          padding: 12px;
          min-height: 48px;
        }

        .bulk-toggle-btn {
          font-size: 1rem;
          padding: 12px 16px;
          min-height: 48px;
          width: 100%;
          background: rgba(255, 255, 255, 0.5);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
        }

        .article-card {
          padding: 1rem; /* „Åï„Çâ„Å´ÂâäÊ∏õ */
          border-radius: 16px;
        }

        .article-title {
          font-size: 1.1rem;
          line-height: 1.4;
        }

        .article-description {
          font-size: 0.95rem;
          line-height: 1.5;
          margin-top: 0.5rem;
        }

        .article-meta span {
          font-size: 0.8rem;
        }

        .series-badge {
          padding: 2px 8px;
        }

        /* Mobile Timeline Adjustments */
        .seminar-sections {
          padding-left: 10px;
          margin-left: 5px;
          gap: var(--spacing-sm);
        }

        .seminar-sections::before {
          left: 4px;
        }

        .seminar-section-item {
          padding: 4px 0 4px 16px;
          background: transparent;
          border: none;
        }

        .seminar-section-item:hover {
          background: transparent;
          transform: none;
        }

        .section-number {
          width: 18px;
          height: 18px;
          font-size: 0.6rem;
          position: absolute;
          left: -15px;
          top: 8px;
          z-index: 2;
        }

        .section-header {
          position: relative;
          margin-bottom: 2px;
        }

        .section-title {
          font-size: 0.9rem;
          line-height: 1.4;
        }

        .section-description {
          font-size: 0.85rem;
          margin-left: 0;
        }
      }

      .glossary-related-count {
        font-size: 0.75rem;
        color: var(--text-tertiary);
        font-weight: 500;
      }

      .glossary-related-articles {
        margin-top: var(--spacing-sm);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .glossary-related-item {
        padding: var(--spacing-sm);
        background: rgba(255, 255, 255, 0.3);
        border-radius: var(--radius-lg);
        transition: background 0.15s ease;
      }

      .glossary-related-item:hover {
        background: rgba(255, 255, 255, 0.6);
      }

      .glossary-related-item a {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--spacing-sm);
        color: inherit;
        text-decoration: none;
      }

      .glossary-related-title {
        font-size: 0.9rem;
        font-weight: 500;
        flex: 1;
      }

      .glossary-related-date {
        font-size: 0.75rem;
        color: var(--color-text-tertiary);
        white-space: nowrap;
      }

      .hidden {
        display: none !important;
      }

      /* Seminar sections - Timeline Style */
      .seminar-sections {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        display: none;
        flex-direction: column;
        gap: var(--spacing-md);
        opacity: 0;
        transition: opacity 0.3s ease;
        position: relative;
        padding-left: 24px;
      }

      .seminar-sections::before {
        content: "";
        position: absolute;
        top: var(--spacing-md);
        bottom: var(--spacing-md);
        left: 9px;
        width: 2px;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 1px;
      }

      .article-card.expanded .seminar-sections {
        display: flex;
        opacity: 1;
      }

      .seminar-section-item {
        padding: var(--spacing-sm);
        text-decoration: none;
        color: inherit;
        transition: all 0.2s ease;
        display: block;
        position: relative;
      }

      .seminar-section-item:hover {
        background: rgba(255, 255, 255, 0.6);
        border-color: var(--color-accent);
        transform: translateX(4px);
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        margin-bottom: 4px;
      }

      .section-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: linear-gradient(135deg, var(--color-accent) 0%, #5856d6 100%);
        color: white;
        font-size: 0.7rem;
        font-weight: 700;
        position: absolute;
        left: -25px;
        top: 10px;
        z-index: 2;
      }

      .section-time {
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--color-text-tertiary);
        font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      }

      .section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--color-text);
        line-height: 1.4;
        margin-bottom: 2px;
      }

      .section-description {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        line-height: 1.4;
      }

      .section-chevron {
        margin-left: auto;
        font-size: 0.7rem;
        color: var(--color-text-tertiary);
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>

    <!-- Floating Controls (Permanent Sticky) -->
    <div class="floating-controls" id="floating-controls">
      <div class="floating-container">
        <div class="main-filter-buttons">
          <button class="main-filter-button active" data-main-filter="videos" title="ÂãïÁîª">üé•</button>
          <button class="main-filter-button" data-main-filter="digital-note" title="„Éá„Ç∏„Çø„É´„Éé„Éº„Éà">üíª</button>
          <button class="main-filter-button" data-main-filter="lifestyle" title="„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí">üìö</button>
          <button class="main-filter-button" data-main-filter="column" title="„Ç≥„É©„É†">‚úçÔ∏è</button>
          <button class="main-filter-button" data-main-filter="contributions" title="ÂØÑÁ®øË®ò‰∫ã">üë•</button>
          <button class="main-filter-button" data-main-filter="glossary" title="Áî®Ë™ûÈõÜ">üìñ</button>
          <button class="main-filter-button" data-main-filter="notes" title="„Éé„Éº„Éà">üìù</button>
        </div>
        <div class="controls-section">
          <div class="segmented-control" id="floating-sort-control">
            <button class="segmented-control-option active" data-sort="newest" title="Êñ∞„Åó„ÅÑÈ†Ü">üÜï</button>
            <button class="segmented-control-option" data-sort="oldest" title="Âè§„ÅÑÈ†Ü">‚è≥</button>
          </div>
          <button id="floating-bulk-toggle-btn" class="bulk-toggle-btn" title="„Åô„Åπ„Å¶Èñã„Åè/Èñâ„Åò„Çã">üìÇ</button>
        </div>
      </div>
    </div>

    <div class="container">
      <header class="header">
        <h1 class="site-title">Knowledge Stack</h1>


        <!-- Main filter buttons - horizontal -->
        <div class="main-filter-buttons">
          <button class="main-filter-button active" data-main-filter="videos">üé• ÂãïÁîª</button>
          <button class="main-filter-button" data-main-filter="digital-note">üíª „Éá„Ç∏„Çø„É´„Éé„Éº„Éà</button>
          <button class="main-filter-button" data-main-filter="lifestyle">üìö „É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí</button>
          <button class="main-filter-button" data-main-filter="column">‚úçÔ∏è „Ç≥„É©„É†</button>
          <button class="main-filter-button" data-main-filter="contributions">üë• ÂØÑÁ®øË®ò‰∫ã</button>
          <button class="main-filter-button" data-main-filter="glossary">üìñ Áî®Ë™ûÈõÜ</button>
          <button class="main-filter-button" data-main-filter="notes">üìù „Éé„Éº„Éà</button>
        </div>

        <!-- Videos filter list -->
        <div class="filter-list-section visible" id="videos-filter-list">
          <div class="filter-buttons">
            <button class="filter-button active" data-filter-type="video-series" data-filter-value="all">
              „Åô„Åπ„Å¶
              <span class="filter-count">{processedVideos.length}</span>
            </button>
            <button class="filter-button" data-filter-type="video-series" data-filter-value="„Çª„Éü„Éä„Éº">
              „Çª„Éü„Éä„Éº
              <span class="filter-count">{processedVideos.filter(v => v.data.series_name === '„Çª„Éü„Éä„Éº').length}</span>
            </button>
            <button class="filter-button" data-filter-type="video-series" data-filter-value="Obsidian„ÅÆÂÖ®ÊäÄË°ì">
              Obsidian„ÅÆÂÖ®ÊäÄË°ì
              <span class="filter-count">{processedVideos.filter(v => v.data.series_name === 'Obsidian„ÅÆÂÖ®ÊäÄË°ì').length}</span>
            </button>
          </div>
        </div>

        <!-- Digital Note filter list -->
        <div class="filter-list-section" id="digital-note-filter-list">
          <div class="filter-buttons">
            {seriesHierarchy['„Éá„Ç∏„Çø„É´„Éé„Éº„Éà'] && Object.entries(seriesHierarchy['„Éá„Ç∏„Çø„É´„Éé„Éº„Éà'].children).map(([child, count]) => (
              <button class="filter-button" data-filter-type="category-child" data-filter-parent="„Éá„Ç∏„Çø„É´„Éé„Éº„Éà" data-filter-child={child}>
                {child}
                <span class="filter-count">{count}</span>
              </button>
            ))}
          </div>
        </div>

        <!-- Lifestyle filter list -->
        <div class="filter-list-section" id="lifestyle-filter-list">
          <div class="filter-buttons">
            {seriesHierarchy['„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí'] && Object.entries(seriesHierarchy['„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí'].children).map(([child, count]) => (
              <button class="filter-button" data-filter-type="category-child" data-filter-parent="„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí" data-filter-child={child}>
                {child}
                <span class="filter-count">{count}</span>
              </button>
            ))}
          </div>
        </div>

        <!-- Column filter list -->
        <div class="filter-list-section" id="column-filter-list">
          <div class="filter-buttons">
            {seriesHierarchy['„Ç≥„É©„É†'] && Object.entries(seriesHierarchy['„Ç≥„É©„É†'].children).map(([child, count]) => (
              <button class="filter-button" data-filter-type="category-child" data-filter-parent="„Ç≥„É©„É†" data-filter-child={child}>
                {child}
                <span class="filter-count">{count}</span>
              </button>
            ))}
          </div>
        </div>

        <!-- Contributions filter list -->
        <div class="filter-list-section" id="contributions-filter-list">
          <div class="filter-buttons">
            {seriesHierarchy['ÂØÑÁ®øË®ò‰∫ã'] && Object.entries(seriesHierarchy['ÂØÑÁ®øË®ò‰∫ã'].children).map(([child, count]) => (
              <button class="filter-button" data-filter-type="category-child" data-filter-parent="ÂØÑÁ®øË®ò‰∫ã" data-filter-child={child}>
                {child}
                <span class="filter-count">{count}</span>
              </button>
            ))}
          </div>
        </div>

        <!-- Glossary filter list -->
        <div class="filter-list-section" id="glossary-filter-list">
          <div class="filter-buttons">
            <button class="filter-button active" data-filter-type="glossary-category" data-filter-value="all">
              „Åô„Åπ„Å¶
              <span class="filter-count">{glossary.length}</span>
            </button>
            {glossaryCategories.map(category => {
              const termsInCategory = glossaryByCategory[category];
              return (
                <button
                  class="filter-button"
                  data-filter-type="glossary-category"
                  data-filter-value={category}
                >
                  {category}
                  <span class="filter-count">{termsInCategory.length}</span>
                </button>
              );
            })}
          </div>
        </div>

        <!-- Notes filter list -->
        <div class="filter-list-section" id="notes-filter-list">
          <div class="filter-buttons">
            <button class="filter-button active" data-filter-type="note-type" data-filter-value="all">
              „Åô„Åπ„Å¶
              <span class="filter-count">{sortedAtomicNotes.length}</span>
            </button>
            <button class="filter-button" data-filter-type="note-type" data-filter-value="principle">
              Principle
              <span class="filter-count">{sortedAtomicNotes.filter(n => n.data.note_type === 'principle').length}</span>
            </button>
            <button class="filter-button" data-filter-type="note-type" data-filter-value="method">
              Method
              <span class="filter-count">{sortedAtomicNotes.filter(n => n.data.note_type === 'method').length}</span>
            </button>
            <button class="filter-button" data-filter-type="note-type" data-filter-value="insight">
              Insight
              <span class="filter-count">{sortedAtomicNotes.filter(n => n.data.note_type === 'insight').length}</span>
            </button>
            <button class="filter-button" data-filter-type="note-type" data-filter-value="technique">
              Technique
              <span class="filter-count">{sortedAtomicNotes.filter(n => n.data.note_type === 'technique').length}</span>
            </button>
            <button class="filter-button" data-filter-type="note-type" data-filter-value="definition">
              Definition
              <span class="filter-count">{sortedAtomicNotes.filter(n => n.data.note_type === 'definition').length}</span>
            </button>
            <button class="filter-button" data-filter-type="note-type" data-filter-value="unknown">
              Êú™ÂàÜÈ°û
              <span class="filter-count">{sortedAtomicNotes.filter(n => !n.data.note_type).length}</span>
            </button>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls-section">
          <div class="segmented-control" id="sort-segmented-control" data-value="newest">
            <div class="segmented-control-slider"></div>
            <button class="segmented-control-option active" data-sort="newest">üÜï Êñ∞„Åó„ÅÑÈ†Ü</button>
            <button class="segmented-control-option" data-sort="oldest">‚è≥ Âè§„ÅÑÈ†Ü</button>
          </div>
          <button class="bulk-toggle-btn" id="bulk-toggle-btn">üìÇ „Åô„Åπ„Å¶Èñã„Åè</button>
        </div>
      </header>

      <!-- Result header -->
      <div class="result-header" id="result-header">
        <h2 id="current-filter-title">ÂãïÁîª</h2>
        <div class="result-count" id="result-count">{processedVideos.length} ‰ª∂</div>
        <button class="clear-filter-btn hidden" id="clear-filter-btn">‚úï „Éï„Ç£„É´„Çø„Éº„Çí„ÇØ„É™„Ç¢</button>
      </div>

      <!-- Video list -->
      <div class="article-list" id="video-list">
        {processedVideos.map((video, index) => (
          <article
            class="article-card"
            style={`animation-delay: ${0.1 + (index % 10) * 0.04}s`}
            data-series={video.data.series_name}
            data-title={(video.data.title || '').toLowerCase()}
            data-date={new Date(video.data.date_published).getTime()}
          >
            <div class="article-header">
              <div class="article-content">
                <div class="article-meta">
                  <span class="series-badge">üì∫ {video.data.series_name}</span>
                  <span class="article-date">
                    {new Date(video.data.date_published).toLocaleDateString('ja-JP', {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit'
                    })}
                  </span>
                </div>
                <div class="article-title">{video.data.title}</div>
                <div class="article-description">
                  {video.data.description || "ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíË¶ÅÁ¥Ñ„Åó„ÅüÊñáÁ´†„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ"}
                </div>
              </div>
              <div class="article-toggle-icon">‚ñº</div>
            </div>

            {video.sections && video.sections.length > 0 && (
              <div class="seminar-sections">
                {video.sections.map((section, index) => (
                    <a href={section.link} target="_blank" rel="noopener noreferrer" class="seminar-section-item">
                      <div class="section-header">
                        <span class="section-number">{index + 1}</span>
                        <span class="section-time">‚è±Ô∏è {section.time}</span>
                        <div class="section-chevron">‚ñ∂</div>
                      </div>
                      <div class="section-title">{section.title}</div>
                      {section.description && <div class="section-description">{section.description}</div>}
                    </a>
                ))}
              </div>
            )}

            <div class="article-footer">
              <a href={video.data.url} target="_blank" rel="noopener noreferrer" class="read-more-btn">
                ÂãïÁîª„ÇíË¶ã„Çã
              </a>
            </div>
          </article>
        ))}
      </div>

      <!-- Article list -->
      <div class="article-list hidden" id="article-list">
        {sortedArticles.map((article, index) => {
          const { parent, child } = getFolderPath(article.id);
          const folderPath = child ? `${parent}/${child}` : parent;

          return (
            <article
              class="article-card"
              style={`animation-delay: ${0.1 + (index % 10) * 0.04}s`}
              data-series-parent={parent}
              data-series-child={child || ''}
              data-title={(article.data.title || '').toLowerCase()}
              data-date={new Date(article.data.date_published).getTime()}
            >
              <div class="article-header">
                <div class="article-content">
                  <div class="article-meta">
                    <span class="series-badge">üìÑ {folderPath}</span>
                    <span class="article-date">
                      {new Date(article.data.date_published).toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                      })}
                    </span>
                  </div>
                  <div class="article-title">{article.data.title}</div>
                  <div class="article-description">
                    {article.data.description || "Ë®ò‰∫ã„ÅÆÊ¶ÇË¶Å„ÉÜ„Ç≠„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ"}
                  </div>
                </div>
                <div class="article-toggle-icon">‚ñº</div>
              </div>

              <div class="article-footer">
                <a href={article.data.url} target="_blank" rel="noopener noreferrer" class="read-more-btn">
                  Ë®ò‰∫ã„ÇíË™≠„ÇÄ
                </a>
              </div>
            </article>
          );
        })}
      </div>

      <div class="empty-state hidden" id="empty-state">
        <p>Ë©≤ÂΩì„Åô„ÇãË®ò‰∫ã„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</p>
      </div>

      <!-- Glossary list -->
      <div class="glossary-list hidden" id="glossary-list">
        {renderedGlossary.map((term, index) => {
          const relatedVideos = processedVideos.filter(v => v.data.topic === term.data.topic_id);
          const relatedArticles = sortedArticles.filter(a => a.data.topic === term.data.topic_id);
          const relatedNotes = sortedAtomicNotes.filter(n => n.data.topic?.includes(term.data.topic_id));
          const recommendedArticles = term.data.recommended_articles || [];

          return (
            <div
              class="glossary-card-wrapper"
              data-category={term.data.category}
              style={`animation-delay: ${0.1 + (index % 10) * 0.04}s`}
              data-date="0"
            >
              <GlossaryCard
                title={term.data.title}
                slug={term.slug}
                yomikata={term.data.yomikata}
                aliases={term.data.aliases}
                category={term.data.category}
                description={term.data.description}
              >
                <term.Content />
              </GlossaryCard>

              {/* Â±ïÈñãÊôÇ„Å´Ë°®Á§∫„Åï„Çå„ÇãË©≥Á¥∞„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
              <div class="glossary-details">
                {recommendedArticles.length > 0 && (
                  <div class="glossary-recommended">
                    <h4 class="glossary-section-title">„Åä„Åô„Åô„ÇÅË®ò‰∫ã</h4>
                    <ul class="glossary-recommended-list">
                      {recommendedArticles.map(articleId => {
                        const article = sortedArticles.find(a => a.id.includes(articleId));
                        return article ? (
                          <li>
                            <a href={article.data.url} target="_blank" rel="noopener noreferrer">
                              {article.data.title}
                            </a>
                          </li>
                        ) : null;
                      })}
                    </ul>
                  </div>
                )}

                {(relatedVideos.length + relatedArticles.length + relatedNotes.length) > 0 && (
                  <div class="glossary-related">
                    <h4 class="glossary-section-title">Èñ¢ÈÄ£„Ç≥„É≥„ÉÜ„É≥„ÉÑ <span class="glossary-related-count">({relatedVideos.length + relatedArticles.length + relatedNotes.length}‰ª∂)</span></h4>
                    <div class="glossary-related-articles">
                      {relatedVideos.map(video => (
                        <div class="glossary-related-item">
                          <a href={video.data.url} target="_blank" rel="noopener noreferrer">
                            <span class="glossary-related-title">üé• {video.data.title}</span>
                            <span class="glossary-related-date">
                              {new Date(video.data.date_published).toLocaleDateString('ja-JP', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                              })}
                            </span>
                          </a>
                        </div>
                      ))}
                      {relatedArticles.map(article => (
                        <div class="glossary-related-item">
                          <a href={article.data.url} target="_blank" rel="noopener noreferrer">
                            <span class="glossary-related-title">üìÑ {article.data.title}</span>
                            <span class="glossary-related-date">
                              {new Date(article.data.date_published).toLocaleDateString('ja-JP', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                              })}
                            </span>
                          </a>
                        </div>
                      ))}
                      {relatedNotes.map(note => (
                        <div class="glossary-related-item">
                          <a href={`#note/${note.slug}`}>
                            <span class="glossary-related-title">üìù {note.data.title}</span>
                          </a>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>

      <!-- Atomic Notes list -->
      <div class="article-list hidden" id="notes-list">
        {sortedAtomicNotes.map((note, index) => {
          // Use extracted summary from "## Ê¶ÇË¶Å" section
          const summary = note.summary || note.data.description || '';

          return (
            <div
              class="article-card"
              style={`animation-delay: ${0.1 + (index % 10) * 0.04}s`}
              data-topics={JSON.stringify(note.data.topic || [])}
              data-note-type={note.data.note_type || 'unknown'}
              data-title={(note.data.title || note.slug || '').toLowerCase()}
              data-date="0"
              data-slug={note.slug}
            >
              <div class="article-header">
                <div class="article-content">
                  <div class="article-meta">
                    {note.data.prefix && <span class="series-badge">üìù {note.data.prefix}</span>}
                    {note.data.note_type && <span class="article-topic" style="margin-right: 4px; background: rgba(0,0,0,0.05); color: #666;">{note.data.note_type}</span>}
                    {Array.isArray(note.data.topic) && note.data.topic.map(t => (
                      <span class="article-topic" style="margin-right: 4px;">{t}</span>
                    ))}
                  </div>
                  <div class="article-title">{note.data.title}</div>
                  <div class="article-description">
                    {summary}
                  </div>
                </div>
                <div class="article-toggle-icon">‚ñº</div>
              </div>

              {/* Â±ïÈñãÊôÇ„Å´Ë°®Á§∫„Åï„Çå„ÇãÊú¨Êñá„Éó„É¨„Éì„É•„ÉºÔºàÊ¶ÇË¶Å„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈô§„ÅèÔºâ */}
              <div class="note-details">
                <div class="note-body-preview">
                  <note.Content />
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>

    <script>
      let currentMode = 'videos';
      let currentVideoSeries = 'all';
      let currentCategoryChild = '';
      let currentGlossaryCategory = 'all';
      let currentNoteTopic = 'all';
      let currentNoteType = 'all';
      let currentSort = 'newest';
      let activeNoteFilter = null;

      // DOM Elements (re-queried on page load)
      let videoList, articleList, glossaryList, notesList, emptyState, resultCount, filterTitle, sortSegmentedControl, bulkToggleBtn;
      let floatingControls;
      let filterLists = {};
      let modeLists = {};

      function initElements() {
        videoList = document.getElementById('video-list');
        articleList = document.getElementById('article-list');
        glossaryList = document.getElementById('glossary-list');
        notesList = document.getElementById('notes-list');
        emptyState = document.getElementById('empty-state');
        resultCount = document.getElementById('result-count');
        filterTitle = document.getElementById('current-filter-title');
        sortSegmentedControl = document.getElementById('sort-segmented-control');
        bulkToggleBtn = document.getElementById('bulk-toggle-btn');
        floatingControls = document.getElementById('floating-controls');

        modeLists = {
          videos: videoList,
          'digital-note': articleList,
          lifestyle: articleList,
          column: articleList,
          contributions: articleList,
          glossary: glossaryList,
          notes: notesList
        };

        filterLists = {
          videos: document.getElementById('videos-filter-list'),
          'digital-note': document.getElementById('digital-note-filter-list'),
          lifestyle: document.getElementById('lifestyle-filter-list'),
          column: document.getElementById('column-filter-list'),
          contributions: document.getElementById('contributions-filter-list'),
          glossary: document.getElementById('glossary-filter-list'),
          notes: document.getElementById('notes-filter-list')
        };
      }

      // Restore state from sessionStorage
      function restoreState() {
        const savedMode = sessionStorage.getItem('portal_currentMode');
        if (savedMode) currentMode = savedMode;
        // Restore other filters if needed, but mode is most important for "Back" button
      }

      // Save state to sessionStorage
      function saveState() {
        sessionStorage.setItem('portal_currentMode', currentMode);
      }

      // Permanent Sticky Bar Logic (needs re-attaching)
      function initScrollListener() {
        const scrollThreshold = 150;
        const handleScroll = () => {
          if (!floatingControls) return;
          const currentScrollY = window.scrollY;
          if (currentScrollY > scrollThreshold) {
            floatingControls.classList.add('visible');
          } else {
            floatingControls.classList.remove('visible');
          }
        };
        window.removeEventListener('scroll', handleScroll); // Clean up old if any
        window.addEventListener('scroll', handleScroll);
      } // End of attachEventListeners

      function toggleBulkExpand() {
        const currentList = modeLists[currentMode];
        const visibleCards = Array.from(currentList.querySelectorAll('.article-card:not(.hidden), .glossary-card-wrapper:not(.hidden)'));
        const anyExpanded = visibleCards.some(card => card.classList.contains('expanded'));

        visibleCards.forEach(card => {
          card.classList.toggle('expanded', !anyExpanded);
        });

        updateBulkToggleVisibility();
      }

      // Global Click Listener (Delegate) - persistent across page transitions so keep outside
      document.addEventListener('click', (e) => {
        const card = (e.target).closest('.article-card');
        const glossaryCardWrapper = (e.target).closest('.glossary-card-wrapper');
        const readMoreBtn = (e.target).closest('.read-more-btn');
        const seminarItem = (e.target).closest('.seminar-section-item');
        const relatedLink = (e.target).closest('.glossary-related-item a');
        const noteBodyLink = (e.target).closest('.note-body-preview a');
        const wikiLink = (e.target).closest('.wiki-link');
        const glossaryLink = (e.target).closest('.glossary-links a');

        // Handle wiki link clicks
        if (wikiLink) {
          e.preventDefault();
          const noteSlug = wikiLink.getAttribute('data-note-slug');
          if (noteSlug) {
            activeNoteFilter = noteSlug;
            currentMode = 'notes';
            updateUI();
            document.getElementById('clear-filter-btn').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            setTimeout(() => {
              const noteCard = document.querySelector(`#notes-list .article-card:not(.hidden)`);
              if (noteCard) {
                noteCard.classList.add('expanded');
                noteCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 100);
          }
          return;
        }

        if (card && !readMoreBtn && !seminarItem && !relatedLink && !noteBodyLink) {
          card.classList.toggle('expanded');
        }

        if (glossaryCardWrapper && !glossaryLink && !relatedLink) {
          glossaryCardWrapper.classList.toggle('expanded');
          updateBulkToggleVisibility();
        }
      });

      // Hash-based navigation for notes
      function handleHashChange() {
        const hash = window.location.hash;
        if (!hash) return;

        const match = hash.match(/^#note\/(.+)$/);
        if (!match) return;

        const slug = match[1];
        currentMode = 'notes';
        updateUI();

        setTimeout(() => {
          const noteCard = document.querySelector(`[data-slug="${slug}"]`);
          if (noteCard) {
            noteCard.classList.add('expanded');
            noteCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }

      // Remove summary section from note body preview
      function removeSummaryFromNotePreview() {
        const notePreviews = document.querySelectorAll('#notes-list .note-body-preview');
        notePreviews.forEach(preview => {
          const h2Elements = preview.querySelectorAll('h2');
          for (let i = 0; i < h2Elements.length; i++) {
            const h2 = h2Elements[i];
            if (h2.textContent.trim() === 'Ê¶ÇË¶Å') {
              let currentElement = preview.firstElementChild;
              const elementsToRemove = [];
              while (currentElement && currentElement.tagName !== 'H2') {
                elementsToRemove.push(currentElement);
                currentElement = currentElement.nextElementSibling;
              }
              if (currentElement && currentElement.textContent.trim() === 'Ê¶ÇË¶Å') {
                elementsToRemove.push(currentElement);
                currentElement = currentElement.nextElementSibling;
                while (currentElement && currentElement.tagName !== 'H2') {
                  elementsToRemove.push(currentElement);
                  currentElement = currentElement.nextElementSibling;
                }
              }
              elementsToRemove.forEach(el => el.remove());
              break;
            }
          }
        });
      }

      function setNoteLinksToNewTab() {
        const noteBodyLinks = document.querySelectorAll('.note-body-preview a');
        noteBodyLinks.forEach(link => {
          if (!link.classList.contains('wiki-link')) {
            link.setAttribute('target', '_blank');
            link.setAttribute('rel', 'noopener noreferrer');
          }
        });
      }

      function attachEventListeners() {
        // Main Mode Switch
        document.querySelectorAll('.main-filter-button').forEach(btn => {
          btn.addEventListener('click', () => {
            currentMode = btn.dataset.mainFilter;
            saveState();
            currentCategoryChild = '';
            activeNoteFilter = null;
            const clearBtn = document.getElementById('clear-filter-btn');
            if (clearBtn) clearBtn.classList.add('hidden');
            updateUI();
          });
        });

        // Video Filters
        document.querySelectorAll('[data-filter-type="video-series"]').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('[data-filter-type="video-series"]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentVideoSeries = btn.dataset.filterValue;
            filterContent();
          });
        });

        // Category Child Filters
        document.querySelectorAll('[data-filter-type="category-child"]').forEach(btn => {
          btn.addEventListener('click', () => {
            const filterList = btn.closest('.filter-list-section');
            if (filterList) {
              filterList.querySelectorAll('[data-filter-type="category-child"]').forEach(b => b.classList.remove('active'));
            }
            btn.classList.add('active');
            currentCategoryChild = btn.dataset.filterChild;
            filterContent();
          });
        });

        // Glossary Filters
        document.querySelectorAll('[data-filter-type="glossary-category"]').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('[data-filter-type="glossary-category"]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentGlossaryCategory = btn.dataset.filterValue;
            filterContent();
          });
        });

        // Note Type Filters
        document.querySelectorAll('[data-filter-type="note-type"]').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('[data-filter-type="note-type"]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentNoteType = btn.dataset.filterValue;
            filterContent();
          });
        });

        // Sort Control
        document.querySelectorAll('.segmented-control-option').forEach(option => {
          option.addEventListener('click', () => {
            currentSort = option.dataset.sort;
            updateUI();
          });
        });

        // Bulk Toggle
        const bulkBtn = document.getElementById('bulk-toggle-btn');
        if (bulkBtn) bulkBtn.addEventListener('click', toggleBulkExpand);
        const floatingBulkBtn = document.getElementById('floating-bulk-toggle-btn');
        if (floatingBulkBtn) floatingBulkBtn.addEventListener('click', toggleBulkExpand);
        
        // Clear Filter
        const clearBtn = document.getElementById('clear-filter-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                activeNoteFilter = null;
                clearBtn.classList.add('hidden');
                updateUI();
            });
        }
      }

      function updateUI() {
        // Show/hide lists - article modes share the same list
        const articleModes = ['digital-note', 'lifestyle', 'column', 'contributions'];
        const isArticleMode = articleModes.includes(currentMode);

        if (videoList) videoList.classList.toggle('hidden', currentMode !== 'videos');
        if (articleList) articleList.classList.toggle('hidden', !isArticleMode);
        if (glossaryList) glossaryList.classList.toggle('hidden', currentMode !== 'glossary');
        if (notesList) notesList.classList.toggle('hidden', currentMode !== 'notes');

        // Show/hide filter lists
        Object.keys(filterLists).forEach(mode => {
          if (filterLists[mode]) {
            filterLists[mode].classList.toggle('hidden', mode !== currentMode);
            filterLists[mode].classList.toggle('visible', mode === currentMode);
          }
        });

        // Update main buttons (both header and floating)
        document.querySelectorAll('.main-filter-button').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.mainFilter === currentMode);
        });

        // Update sort controls (both header and floating)
        document.querySelectorAll('.segmented-control-option').forEach(btn => {
          btn.classList.toggle('active', btn.dataset.sort === currentSort);
        });

        // Update slider position
        document.querySelectorAll('.segmented-control').forEach(control => {
          control.setAttribute('data-value', currentSort);
        });

        // Filter and Sort
        filterContent();
      }

      function filterContent() {
        if (!modeLists[currentMode]) return;
        const currentList = modeLists[currentMode];
        const cards = Array.from(currentList.querySelectorAll('.article-card, .glossary-card-wrapper'));
        let visibleCount = 0;

        // Mode to parent folder mapping
        const modeToParent = {
          'digital-note': '„Éá„Ç∏„Çø„É´„Éé„Éº„Éà',
          'lifestyle': '„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí',
          'column': '„Ç≥„É©„É†',
          'contributions': 'ÂØÑÁ®øË®ò‰∫ã'
        };

        cards.forEach(card => {
          let isVisible = false;

          if (currentMode === 'videos') {
            const series = card.dataset.series;
            const seriesMatch = currentVideoSeries === 'all' || series === currentVideoSeries;
            isVisible = seriesMatch;
          } else if (modeToParent[currentMode]) {
            // Article category modes
            const parent = card.dataset.seriesParent;
            const child = card.dataset.seriesChild;
            const expectedParent = modeToParent[currentMode];

            const parentMatch = parent === expectedParent;
            const childMatch = currentCategoryChild === '' || child === currentCategoryChild;
            isVisible = parentMatch && childMatch;
          } else if (currentMode === 'glossary') {
            const category = card.dataset.category;
            const categoryMatch = currentGlossaryCategory === 'all' || category === currentGlossaryCategory;
            isVisible = categoryMatch;
          } else if (currentMode === 'notes') {
            // Check if there's an active note filter
            if (activeNoteFilter) {
              const cardTitle = (card.dataset.title || '').toLowerCase();
              const filterTitle = activeNoteFilter.toLowerCase();
              isVisible = cardTitle === filterTitle;
            } else {
              // Note Type Filter
              const noteType = card.dataset.noteType || 'unknown';
              const typeMatch = currentNoteType === 'all' || noteType === currentNoteType;
              isVisible = typeMatch;
            }
          }

          card.classList.toggle('hidden', !isVisible);
          if (isVisible) visibleCount++;
        });

        if (emptyState) emptyState.classList.toggle('hidden', visibleCount > 0);
        if (resultCount) resultCount.textContent = `${visibleCount} ‰ª∂`;

        // Update Title
        updateTitle();

        // Sort if applicable
        if (currentMode !== 'glossary') {
          sortContent();
        }

        // Update bulk toggle button visibility
        updateBulkToggleVisibility();
      }

      function updateBulkToggleVisibility() {
        const articleModes = ['digital-note', 'lifestyle', 'column', 'contributions'];
        const hasExpandableCards = currentMode === 'videos' || articleModes.includes(currentMode) || currentMode === 'glossary' || currentMode === 'notes';
        if (bulkToggleBtn) bulkToggleBtn.classList.toggle('hidden', !hasExpandableCards);
        const floatingBulkBtn = document.getElementById('floating-bulk-toggle-btn');
        if (floatingBulkBtn) floatingBulkBtn.classList.toggle('hidden', !hasExpandableCards);

        if (modeLists[currentMode]) {
          const anyExpanded = Array.from(modeLists[currentMode].querySelectorAll('.article-card.expanded, .glossary-card-wrapper.expanded')).length > 0;
          if (bulkToggleBtn) bulkToggleBtn.textContent = anyExpanded ? 'üìÅ „Åô„Åπ„Å¶Èñâ„Åò„Çã' : 'üìÇ „Åô„Åπ„Å¶Èñã„Åè';
          if (floatingBulkBtn) floatingBulkBtn.textContent = anyExpanded ? 'üìÅ' : 'üìÇ';
        }
      }

      function updateTitle() {
        let title = '';
        const modeToTitle = {
          'digital-note': '„Éá„Ç∏„Çø„É´„Éé„Éº„Éà',
          'lifestyle': '„É©„Ç§„Éï„Çπ„Çø„Ç§„É´„ÉªÂ≠¶Áøí',
          'column': '„Ç≥„É©„É†',
          'contributions': 'ÂØÑÁ®øË®ò‰∫ã'
        };

        if (currentMode === 'videos') {
          title = currentVideoSeries === 'all' ? '„Åô„Åπ„Å¶„ÅÆÂãïÁîª' : currentVideoSeries;
        } else if (modeToTitle[currentMode]) {
          // Article category modes
          title = currentCategoryChild ? `${modeToTitle[currentMode]} / ${currentCategoryChild}` : modeToTitle[currentMode];
        } else if (currentMode === 'glossary') {
          title = currentGlossaryCategory === 'all' ? 'Áî®Ë™ûÈõÜ' : currentGlossaryCategory;
        } else if (currentMode === 'notes') {
          if (activeNoteFilter) {
            title = `üìå ${activeNoteFilter}`;
          } else {
            const noteTypeNames = {
              'all': '„Ç¢„Éà„Éü„ÉÉ„ÇØ„Éé„Éº„Éà',
              'principle': 'ÂéüÁêÜ„ÉªÂéüÂâá (Principle)',
              'method': 'ÊâãÊ≥ï„ÉªÊñπÊ≥ïË´ñ (Method)',
              'insight': 'Ê¥ûÂØü„ÉªË¶ñÁÇπ (Insight)',
              'technique': 'ÊäÄË°ì„Éª„Ç≥„ÉÑ (Technique)',
              'definition': 'ÂÆöÁæ© (Definition)',
              'unknown': 'Êú™ÂàÜÈ°û'
            };
            title = noteTypeNames[currentNoteType] || currentNoteType;
          }
        }

        if (filterTitle) filterTitle.textContent = title;
      }

      function sortContent() {
        if (!modeLists[currentMode]) return;
        const currentList = modeLists[currentMode];
        const cards = Array.from(currentList.querySelectorAll('.article-card:not(.hidden), .glossary-card-wrapper:not(.hidden)'));

        cards.sort((a, b) => {
          const dateA = parseInt(a.dataset.date || '0');
          const dateB = parseInt(b.dataset.date || '0');
          return currentSort === 'newest' ? dateB - dateA : dateA - dateB;
        });

        cards.forEach(card => currentList.appendChild(card));
      }

      // Initialize on page load
      document.addEventListener('astro:page-load', () => {
        initElements();
        restoreState();
        initScrollListener();
        attachEventListeners();
        updateUI();

        // Listen for hash changes
        window.removeEventListener('hashchange', handleHashChange);
        window.addEventListener('hashchange', handleHashChange);
        handleHashChange();

        // Note content fixes
        removeSummaryFromNotePreview();
        setNoteLinksToNewTab();
      });
    </script>
  </body>
</html>
